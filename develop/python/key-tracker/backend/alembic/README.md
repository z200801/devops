# Using Alembic for Database Migrations

## Installation

Alembic is already included in `requirements.txt`. If you're installing dependencies manually:

```bash
pip install alembic
```

## Directory Structure

```
alembic/
├── versions/                  # Migration files are stored here
│   ├── __init__.py
│   └── 0001_initial_tables.py # Initial migration
├── __init__.py
├── env.py                     # Alembic environment configuration
└── script.py.mako             # Template for new migrations
```

## Basic Alembic Commands

### 1. Applying Migrations

To apply all migrations:

```bash
alembic upgrade head
```

To apply to a specific version:

```bash
alembic upgrade +1     # One migration forward
alembic upgrade <id>   # Migration to a specific version
```

### 2. Rolling Back Migrations

```bash
alembic downgrade -1   # Roll back one migration
alembic downgrade base # Roll back all migrations
```

### 3. Creating New Migrations

Automatically generate based on model differences:

```bash
alembic revision --autogenerate -m "description of changes"
```

Create an empty migration:

```bash
alembic revision -m "description of changes"
```

### 4. Viewing Information

Current version:
```bash
alembic current
```

Migration history:
```bash
alembic history
```

## Working with Docker

In the Docker container, migrations are automatically applied at startup via `start.sh`.

## Modifying an Existing Database

If you already have a populated database but want to start using Alembic:

1. Create an empty migration:
   ```bash
   alembic revision -m "baseline"
   ```

2. Edit the migration file to accurately reflect the current schema state.

3. Mark this migration as applied:
   ```bash
   alembic stamp head
   ```

4. Create new migrations as usual going forward.

## Troubleshooting

### Common Issues

1. **Can't connect to database**:
   - Check environment variables for correct database connection details
   - Ensure the database server is running and accessible

2. **Autogenerate doesn't detect changes**:
   - Make sure all models are imported in `env.py`
   - Check that model definitions include all required SQLAlchemy columns and relationships

3. **Migration conflicts**:
   - When merging code from different branches, you may need to manually resolve migration file conflicts
   - Consider using branch labels for complex projects with multiple development paths

### Migration Best Practices

1. Always review autogenerated migrations before applying them
2. Run migrations in a test environment before production
3. Include migrations in your version control system
4. Consider creating data migrations for complex data transformations

